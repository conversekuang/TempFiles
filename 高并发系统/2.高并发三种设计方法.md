



#### 高并发通用设计方法



高并发代表着大流量。

高并发系统：如何通过巧妙的系统设计方案来抵抗巨大的流量冲击。让流量平稳的的被系统处理。

类比：都江堰抗洪水患。

对抗大流量的三种思路：

- Scale-out（横向扩展）：分布式部署，将流量分开，让每个服务器承担一部分并发和流量。
- 缓存：使用缓存来提高系统性能。减少读取数据速度来提升单位时间内处理数量。
- 异步：让未处理的请求先返回，等数据处理完再通知请求方，可以使单位时间内出来的请求数量更多。



##### Scale-up 与 Scale-out

- Scale-up(纵向扩展): 通过硬件升级系统的方式来提高系统的并发能力。（但是硬件资源的提升可能不是线性的，增加相同配置的硬件资源并不代表请求数量能倍增。）

- Scale-out(横向扩展): 通过多个低性能的机器组成分布式集群来抵御高并发大流量。例如：数据库一主多从，分库分表，存储分片等来解决不同瓶颈上的分布式应用。



> 选择Scale-up 与 Scale-out

- Scale-up ：足够简单；但是当并发超过单机极限的时候，要用Scale-out。（自己想到，例如并发数量突破端口限制）

- Scale-out：能够突破单机限制；但是复杂，而且引入单点问题，数据一致性问题，无感知增加与删除节点问题等。



##### 用缓存提升性能

数据持久化存储在硬盘中，但是读取磁盘需要花费大量时间在寻道上：普通磁盘寻道时间是10ms，但是CPU执行指令与内存寻址在ns级别，千兆网卡读取数据时间在us级别，所以磁盘读取数据是最慢的。



缓存的大范围概念：能降低响应时间的中间存储都称为缓存。例如：CPU中缓存、文件中的Page Cache，浏览器中的缓存。



##### 异步处理

以方法调用中的同步、异步为例：

同步调用：调用方阻塞等到被调用的方法中的逻辑执行完成。

异步调用：调用方不需要等待被调用的方法执行完成就可以返回并执行其他逻辑，在被调用放完成后在通过回调、时间通知的方式反馈给调用方。

![](https://static001.geekbang.org/resource/image/07/09/0756d48f746590894b6e96ae4e4f7609.jpg)

订票时显示正在排队代表着异步处理订票请求。后端会把请求丢到消息队列，加快响应用户说“我们在排队”。最后释放出资源来处理更多请求。订票结果处理后，在通知用户是否成功。该过程将处理逻辑后移到了异步处理程序，web服务器能够处理的压力小了，占用资源少了，能够接到更多的用户请求了。（说白了，就是减少用户占用web服务器资源来处理更多的用户请求，但是压力转到了异步处理，用户不知道需要等多久但是最后能返回结果，需要优化的是用户等待时间。）



##### 系统设计思路与演进

三种思路如上所述单并非每个系统都要用到三种方式，因为并非每个系统或者应用都具有百万，千万并发，需要根据业务进行侧重。系统要根据不同阶段进行推演。

- 最简单的系统设计满足业务需求和流量现状
- 修正架构中存在的问题，选择成熟社区的解决方案
- 当对当前架构下小修小补无法满足，考虑重构、重写等大的调整方式解决问题。



Case：淘宝系统演进

- 0到1阶段：快速搭建系统
- 流量增长阶段：数据库引擎从MyISAM迁移到InnoDB，分库分表，增加缓存等。
- 从单体转换成SOA架构，进化成过亿的QPS技术架构

高并发系统：是为了解决系统中的问题为驱动力的，不是为了追求而追求。





经典评论：

> martin fowler好像曾经说过，能使用单体解决的问题，就不要采用分布式。不能为了技术而技术，采用分布式固然可以分流用户请求，提高系统的响应能力，但同样也带来了复杂性。软件开发最终的目的是商业利益。非常赞成老师的观点，罗马城不是一天就建立起来的。架构的工作应该是阶段性，解决阶段性系统的复杂性。如果单体跑的很好，或者通过scale up方式在成本可控的情况能解决就不要想着诗和远方，因为系统内部的进程间调用，肯定比不同物理机的进程之间调用要快。



> 1.技术在不断演进，演进的目的和内驱动力是解决当前系统存在的问题，过早过度设计大多只会延误系统的发展。一切都以实际情况和需要出发，一步步优化，一步步演进，个人能力提升也是同样的道理。
> 2.高并发系统设计通用方法:水平拓展，缓存，异步。这只是指导思想，如何更巧妙的运用才是最具魅力的。



> 系统设计的时候，不能一心求大，而是应该有多少人做多少饭，避免不必要的浪费。
> 拿做饭举例，假设现在有1口锅，可以一次给10人做饭。
> 突然有一天要给100人做饭，
> scale-out，扩展到10口锅来做饭；
> 缓存，1口锅在人来之前做10次；
> 异步，人来了，让大家先等着，做饭给大家端过去，不要在都在锅边等着。